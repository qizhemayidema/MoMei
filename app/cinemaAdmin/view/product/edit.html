{include file="common/source"}
<script src="__STATIC__/js/plugins/treeview/bootstrap-treeview.js"></script>

<script src="__STATIC__/js/plugins/summernote/summernote.min.js"></script>
<script src="__STATIC__/js/plugins/summernote/summernote-zh-CN.js"></script>
<link rel="stylesheet" href="__STATIC__/css/plugins/summernote/summernote.css">
<link rel="stylesheet" href="__STATIC__/css/plugins/summernote/summernote-bs3.css">
<script src="__STATIC__/plugins/date/js/mock-data.js"></script>
<script src="__STATIC__/plugins/date/js/calendar-price-jquery.js"></script>
<link rel="stylesheet" href="__STATIC__/plugins/date/css/calendar-price-jquery.min.css">
<!--<script src="__STATIC__/js/demo/treeview-demo.js"></script>-->
<style>
    body{
        padding: 0;
    }
    .container{
        width: 100%;
    }
    .calendar-foot-wrapper{
        display: none;
    }
</style>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">

<div class="col-sm-12">
    <div class="ibox-title">
        <h5>修改产品 <small></small></h5>

    </div>
    <div class="ibox-content">

        <form action="" class="form-horizontal">
            <input type="hidden" name="id" value="{$data.id}">
            <input type="hidden" name="cate_id" value="{$data.cate_id}">
            {:token_field()}
            <div class="form-group">
                <label class="col-sm-2 control-label">所属分类</label>
                <div class="col-sm-8">
                    <select class="form-control m-b" disabled name="cate_id">
                        <option value="{$data.cate_id.id}">{$data.cate_name}</option>
                    </select>
                </div>
            </div>
            {if $rule.is_level == 1}
            <div class="form-group">
                <label class="col-sm-2 control-label">选择级别</label>
                <div class="col-sm-8">
                    <select class="form-control m-b" name="level_id">
                        <option value="0">没有级别</option>
                        {foreach $level as $key => $value}
                        <option value="{$value.id}" {if isset($data.level_id) && $data.level_id == $value.id} selected {/if}>{$value.level_name}</option>
                        {/foreach}
                    </select>
                </div>
            </div>
            {else}
            <input type="hidden" name="level_id" value="0">
            {/if}

            {if $rule.is_screen != 0}
            <div class="form-group">
                <label class="col-sm-2 control-label">选择影厅</label>
                <div class="col-sm-8">
                    <select class="form-control m-b" name="screen_id">
                        {if $rule.is_screen == 2}
                        <option value="0">[[不属于影厅]]</option>
                        {/if}
                        {foreach $screen as $key => $value}
                        <option value="{$value.id}" {if isset($data.screen_id) && $data.screen_id == $value.id} selected {/if}>{$value.name}</option>
                        {/foreach}
                    </select>
                </div>
            </div>
            {else}
            <input type="hidden" name="screen_id" value="0">
            {/if}
            <div class="form-group">
                <label class="col-sm-2 control-label">产品名称</label>
                <div class="col-sm-8">
                    <input name="entity_name" value="{$data.entity_name ?? ''}" required  type="text" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">包月价格</label>
                <div class="col-sm-8">
                    <input name="price_month" value="{$data.price_month}" required  type="text" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">包年价格</label>
                <div class="col-sm-8">
                    <input name="price_year" value="{$data.price_year}" required  type="text" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">产品介绍</label>
                <div class="col-sm-8">
                    <div class="summernote" style="width: 700px;">
                        {if isset($data)}
                        {$data.desc|raw}
                        {/if}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">每日价格</label>
                <div class="col-sm-8">
                    <div class="container"></div>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-4 col-sm-offset-2">
                    <button class="btn btn-primary" type="button"  onclick="save()">保存内容</button>
                    <button class="btn btn-white" type="button" onclick="javascript:history.go(-1)">取消</button>
                </div>
            </div>
        </form>

    </div>

</div>
    </div>
</div>
</body>

<script>

    var date = new Date();
    var d = new Date()
    d.setMonth(d.getMonth() + 18); //结束日期
    // 生成模拟数据
    var MOCK_DATA = createMockData();
    // console.log(MOCK_DATA)
    // 日历设置表单字段配置
    // key 字段名
    // name 表单label
    // value 默认值
    // placeholder input[placeholder]
    var calendarConfig = [{
        key: 'dayPrice',
        name: '日价格',
        type: 'number',
        placeholder: '请输入日价格'
    }
        // ,
        //
        // {
        //     key: 'monthPrice',
        //     name: '月价格',
        //     type: 'number',
        //     placeholder: '请输入月价格'
        // },
        // {
        //     key: 'yearPrice',
        //     name: '年价格',
        //     type: 'number',
        //     placeholder: '请输入年价格'
        // }
    ]

    // 日历中显示配置
    var showConfig = [{
        key: 'dayPrice',
        name: '日:￥'
    }
        // ,
        // {
        //     key: 'monthPrice',
        //     name: '月:￥'
        // },
        // {
        //     key: 'yearPrice',
        //     name: '年:￥'
        // }
    ]

    // 样式颜色配置
    var styleConfig = {
        // 头部背景色
        headerBgColor: '#098cc2',
        // 头部文字颜色
        headerTextColor: '#fff',
        // 周一至周日背景色，及文字颜色
        weekBgColor: '#098cc2',
        weekTextColor: '#fff',
        // 周末背景色，及文字颜色
        weekendBgColor: '#098cc2',
        weekendTextColor: '#fff',
        // 有效日期颜色
        validDateTextColor: '#333',
        validDateBgColor: '#fff',
        validDateBorderColor: '#eee',
        // Hover
        validDateHoverBgColor: '#098cc2',
        validDateHoverTextColor: '#fff',
        // 无效日期颜色
        invalidDateTextColor: '#ccc',
        invalidDateBgColor: '#fff',
        invalidDateBorderColor: '#eee',
        // 底部背景颜色
        footerBgColor: '#fff',
        // 重置按钮颜色
        resetBtnBgColor: '#77c351',
        resetBtnTextColor: '#fff',
        resetBtnHoverBgColor: '#55b526',
        resetBtnHoverTextColor: '#fff',
        // 确定按钮
        confirmBtnBgColor: '#098cc2',
        confirmBtnTextColor: '#fff',
        confirmBtnHoverBgColor: '#00649a',
        confirmBtnHoverTextColor: '#fff',
        // 取消按钮
        cancelBtnBgColor: '#fff',
        cancelBtnBorderColor: '#bbb',
        cancelBtnTextColor: '#999',
        cancelBtnHoverBgColor: '#fff',
        cancelBtnHoverBorderColor: '#bbb',
        cancelBtnHoverTextColor: '#666'
    }
    {if isset($data.price_json)}
    var str = {:json_encode($data.price_json,256)};
    {/if}
        // 初始化日历
        var zxCalendar = $.CalendarPrice({
            el: '.container',
            startDate: dateFormat("YYYY-mm-dd", date),
            endDate: dateFormat("YYYY-mm-dd", d),
        {if isset($data.price_json)}
        data: JSON.parse(str),
            {/if}
        // 配置需要设置的字段名称
        config: calendarConfig,
            // 配置在日历中要显示的字段
            show: showConfig,
        // 自定义颜色
        style: styleConfig
    });

        // 监听设置表单提交
        // 将阻止默认流程执行
        // 继续执行默认流程，请执行参数next()
        zxCalendar.$on('submit-form', function (data, next) {
            // data 设置的数据
            console.log('$(submit-form)表单数据 ================')
            console.log(data)

            // 此处可以验证表单
            // 验证表单逻辑....
            // ....

            // 继续执行下一步
            next()
        })

        // 执行过程中错误回调
        zxCalendar.$on('error', function (err) {
            // 执行中的错误提示
            console.error('$on(error)Error:')
            console.log(err)
            alert(err.msg);
        })

        // 切换月份
        zxCalendar.$on('month-change', function (data) {
            console.log(data);
        })

        // 点击有效的某一天通知
        zxCalendar.$on('valid-day', function (day, data, next) {
            console.log(data);

            // 继续执行默认流程
            next();
        })

        // 设置数据变化
        zxCalendar.$on('setup-value-change', function (data) {
            console.log(data);
            // 取消设置
            // 这里可以触发关闭设置窗口
        })

        // 点击重置按钮回调
        zxCalendar.$on('reset', function () {
            console.log('$on(reset)数据重置成功！');
        })
    var save = function(){

        var formData = new FormData($('form')[0]);

        formData.append('price_json',JSON.stringify(zxCalendar.data))

        formData.append('desc',$('.summernote').code())
        $.ajax({
            url: "{:url('update')}",
            type: 'post',
            dataType: 'json',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                if (data.code == 0) {
                    layer.msg(data.msg, {icon: 5})
                } else {
                    layer.msg('提交成功', {icon: 1})
                    setTimeout(function(){
                        window.location.href = "{:url('index')}"

                    },700)
                }
            }
        })
    }
    $(function(){

        $('.summernote').summernote({
            lang: 'zh-CN'
        });

    })


        function dateFormat(fmt, date) { //格式化时间
            let ret;
            let opt = {
                "Y+": date.getFullYear().toString(), // 年
                "m+": (date.getMonth() + 1).toString(), // 月
                "d+": date.getDate().toString(), // 日
                "H+": date.getHours().toString(), // 时
                "M+": date.getMinutes().toString(), // 分
                "S+": date.getSeconds().toString() // 秒
                // 有其他格式化字符需求可以继续添加，必须转化成字符串
            };
            for (let k in opt) {
                ret = new RegExp("(" + k + ")").exec(fmt);
                if (ret) {
                    fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
                }
                ;
            }
            ;
            return fmt;
        };
</script>
